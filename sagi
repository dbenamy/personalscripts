#!/usr/bin/env bash
# sudo apt-get update ; sudo apt-get install

CURRDIR=$(pwd)

function update_machines {
    
    if [[ -z "$PERS_DIR" ]]
    then
        PERS_DIR="$HOME/pers"
    fi
    
    if [[ -d $PERS_DIR/machines      ]] &&
       [[ -d $PERS_DIR/machines/.git ]]
    then
      echo "Updating machines repository."
      cd $PERS_DIR/machines
      git pull --no-edit origin master
    else
      echo "No machines repository found.  Cloning."
      git clone git@bitbucket.org:swirepe/machines.git $PERS_DIR/machines
    fi
    
    
    SAGIRECORD_DIR="$PERS_DIR/machines/apt/$(hostname)"
    
    
    
    if [ ! -d $SAGIRECORD_DIR ]
    then
        echo "[sagi] $SAGIRECORD_DIR does not exist: creating."
        mkdir -p $SAGIRECORD_DIR
fi

}

sudo apt-get update

sudo apt-get install "$@" && ( 
    update_machines &&
    cd "$SAGIRECORD_DIR" &&
    dpkg --get-selections > aptlist.txt &&
    git add aptlist.txt &&
    git commit -m "sagi $(hostname) $*" &&
    git push origin master
)
        
cd "$CURRDIR"
    
